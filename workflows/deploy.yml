name: Deploy TicTacToe Bot & Web App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # ============================================
  # Job 1: Build and Test
  # ============================================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linter
      run: npm run lint || echo "Linter not configured yet"
      continue-on-error: true
      
    - name: Run tests
      run: npm test || echo "Tests not configured yet"
      continue-on-error: true
      
    - name: Build project
      run: npm run build
      
    - name: Verify build output
      run: |
        echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–±–æ—Ä–∫–∏..."
        if [ -d "dist/bot" ]; then
          echo "‚úÖ Bot build —É—Å–ø–µ—à–µ–Ω"
          ls -la dist/bot/ | head -5
        fi
        if [ -d "dist/web" ]; then
          echo "‚úÖ Web App build —É—Å–ø–µ—à–µ–Ω"
          ls -la dist/web/ | head -5
        fi

  # ============================================
  # Job 2: Deploy Web App
  # ============================================
  deploy-web:
    name: Deploy Web App
    needs: build-and-test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build Web App
      run: npm run build:web
      
    - name: Deploy Web App to Beget FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./dist/web/
        server-dir: ${{ secrets.FTP_WEB_PATH }}/
        dangerous-clean-slate: false
        dry-run: false
        exclude: |
          **/.git*
          **/.git*/**
          **/.DS_Store
          **/Thumbs.db
          **/*.map
        log-level: verbose

  # ============================================
  # Job 3: Deploy Bot (if needed)
  # ============================================
  deploy-bot:
    name: Deploy Bot
    needs: build-and-test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build Bot
      run: npm run build:bot
      
    - name: Deploy Bot to Server
      # ‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –¥–µ–ø–ª–æ–π –±–æ—Ç–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –≤–∞—à–µ–º—É —Ö–æ—Å—Ç–∏–Ω–≥—É
      # –ü—Ä–∏–º–µ—Ä—ã: SSH, FTP, Docker, –∏–ª–∏ –¥—Ä—É–≥–æ–π –º–µ—Ç–æ–¥
      run: |
        echo "ü§ñ –î–µ–ø–ª–æ–π –±–æ—Ç–∞..."
        echo "‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –¥–µ–ø–ª–æ–π –±–æ—Ç–∞ —Å–æ–≥–ª–∞—Å–Ω–æ –≤–∞—à–µ–º—É —Ö–æ—Å—Ç–∏–Ω–≥—É"
        # –ü—Ä–∏–º–µ—Ä –¥–ª—è SSH –¥–µ–ø–ª–æ—è:
        # ssh user@server "cd /path/to/bot && git pull && npm install --production && pm2 restart bot"
      continue-on-error: true

  # ============================================
  # Job 4: Deployment Success Notification
  # ============================================
  notify:
    name: Deployment Notification
    needs: [deploy-web, deploy-bot]
    runs-on: ubuntu-latest
    if: success()
    
    steps:
    - name: Deployment Success
      run: |
        echo "üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
        echo "üìÖ –í—Ä–µ–º—è: $(date)"
        echo "‚úÖ Web App —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç"
        echo "‚úÖ Bot —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç"
        echo "üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"

