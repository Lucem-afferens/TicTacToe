name: Deploy TicTacToe Bot & Web App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # ============================================
  # Job 1: Build and Test
  # ============================================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linter
      run: npm run lint || echo "Linter not configured yet"
      continue-on-error: true
      
    - name: Run tests
      run: npm test || echo "Tests not configured yet"
      continue-on-error: true
      
    - name: Build project
      run: npm run build
      
    - name: Verify build output
      run: |
        echo "ðŸ“¦ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð° ÑÐ±Ð¾Ñ€ÐºÐ¸..."
        if [ -d "dist/bot" ]; then
          echo "âœ… Bot build ÑƒÑÐ¿ÐµÑˆÐµÐ½"
          ls -la dist/bot/ | head -5
        fi
        if [ -d "dist/web" ]; then
          echo "âœ… Web App build ÑƒÑÐ¿ÐµÑˆÐµÐ½"
          ls -la dist/web/ | head -5
        fi

  # ============================================
  # Job 2: Deploy Web App and Bot to Beget
  # ============================================
  deploy:
    name: Deploy to Beget
    needs: build-and-test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build project
      run: npm run build
      
    - name: Verify build output
      run: |
        echo "ðŸ“¦ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð° ÑÐ±Ð¾Ñ€ÐºÐ¸..."
        if [ -d "dist/web" ]; then
          echo "âœ… Web App build ÑƒÑÐ¿ÐµÑˆÐµÐ½"
          ls -la dist/web/ | head -5
        fi
        if [ -d "dist/bot" ]; then
          echo "âœ… Bot build ÑƒÑÐ¿ÐµÑˆÐµÐ½"
          ls -la dist/bot/ | head -5
        fi
      
    - name: Create .env file for bot
      run: |
        echo "ðŸ” Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ñ„Ð°Ð¹Ð»Ð° Ð´Ð»Ñ Ð±Ð¾Ñ‚Ð°..."
        mkdir -p dist/bot
        cat > dist/bot/.env << EOF
        BOT_TOKEN=${{ secrets.BOT_TOKEN }}
        BOT_USERNAME=${{ secrets.BOT_USERNAME || 'TicTacToe_ru_bot' }}
        WEB_APP_URL=${{ secrets.WEB_APP_URL || 'https://develonik.ru/' }}
        NODE_ENV=production
        EOF
        echo "âœ… .env Ñ„Ð°Ð¹Ð» ÑÐ¾Ð·Ð´Ð°Ð½ (Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾, Ð½Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ñ‚ÑÑ Ð² Git)"
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ñ‚Ð¾ÐºÐµÐ½ ÐµÑÑ‚ÑŒ (Ð½Ð¾ Ð½Ðµ Ð²Ñ‹Ð²Ð¾Ð´Ð¸Ð¼ ÐµÐ³Ð¾)
        if [ -z "${{ secrets.BOT_TOKEN }}" ]; then
          echo "âš ï¸ BOT_TOKEN Ð½Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð² GitHub Secrets"
        else
          echo "âœ… BOT_TOKEN ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½"
        fi
      
    - name: Deploy Web App to Beget FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./dist/web/
        server-dir: ${{ secrets.FTP_WEB_PATH }}/
        dangerous-clean-slate: false
        dry-run: false
        exclude: |
          **/.git*
          **/.git*/**
          **/.DS_Store
          **/Thumbs.db
          **/*.map
        log-level: verbose
      
    - name: Deploy Bot and .env to Beget FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./dist/bot/
        server-dir: ${{ secrets.FTP_BOT_PATH || secrets.FTP_WEB_PATH }}/bot/
        dangerous-clean-slate: false
        dry-run: false
        exclude: |
          **/.git*
          **/.git*/**
          **/.DS_Store
          **/Thumbs.db
        log-level: verbose
      
    - name: Deploy package files for bot
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./
        server-dir: ${{ secrets.FTP_BOT_PATH || secrets.FTP_WEB_PATH }}/bot/
        dangerous-clean-slate: false
        dry-run: false
        include: |
          package.json
          package-lock.json
        exclude: |
          **/*
          !package.json
          !package-lock.json
        log-level: verbose
      
    - name: Deployment Success
      run: |
        echo "ðŸŽ‰ Ð”ÐµÐ¿Ð»Ð¾Ð¹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
        echo "ðŸŒ Web App: https://develonik.ru/"
        echo "ðŸ¤– Bot: Ð·Ð°Ð´ÐµÐ¿Ð»Ð¾ÐµÐ½ Ð² ${{ secrets.FTP_BOT_PATH || secrets.FTP_WEB_PATH }}/bot/"
        echo "ðŸ” .env Ñ„Ð°Ð¹Ð» Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€ (Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾, Ð½Ðµ Ð² Git)"
        echo "ðŸ“… Ð’Ñ€ÐµÐ¼Ñ: $(date)"

