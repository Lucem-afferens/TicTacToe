name: Deploy TicTacToe Bot & Web App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # ============================================
  # Job 1: Build and Test
  # ============================================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linter
      run: npm run lint || echo "Linter not configured yet"
      continue-on-error: true
      
    - name: Run tests
      run: npm test || echo "Tests not configured yet"
      continue-on-error: true
      
    - name: Build project
      run: npm run build
      
    - name: Verify build output
      run: |
        echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–±–æ—Ä–∫–∏..."
        if [ -d "dist/bot" ]; then
          echo "‚úÖ Bot build —É—Å–ø–µ—à–µ–Ω"
          ls -la dist/bot/ | head -5
        fi
        if [ -d "dist/web" ]; then
          echo "‚úÖ Web App build —É—Å–ø–µ—à–µ–Ω"
          ls -la dist/web/ | head -5
        fi

  # ============================================
  # Job 2: Deploy Web App to Beget
  # –í–ê–ñ–ù–û: Bot –ù–ï –¥–µ–ø–ª–æ–∏—Ç—Å—è –Ω–∞ Beget, —Ç–∞–∫ –∫–∞–∫ —Ç–∞–º –Ω–µ—Ç Node.js
  # Bot –Ω—É–∂–Ω–æ –¥–µ–ø–ª–æ–∏—Ç—å –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (Railway, Render, VPS)
  # –°–º. BOT_DEPLOYMENT.md –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
  # ============================================
  deploy-web:
    name: Deploy Web App to Beget
    needs: build-and-test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build project
      run: npm run build
      
    - name: Verify build output
      run: |
        echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–±–æ—Ä–∫–∏..."
        if [ -d "dist/web" ]; then
          echo "‚úÖ Web App build —É—Å–ø–µ—à–µ–Ω"
          ls -la dist/web/ | head -5
        fi
        if [ -d "dist/bot" ]; then
          echo "‚úÖ Bot build —É—Å–ø–µ—à–µ–Ω"
          ls -la dist/bot/ | head -5
        fi
      
    - name: Prepare Web App files
      run: |
        echo "üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Web App —Ñ–∞–π–ª–æ–≤..."
        mkdir -p deploy-web
        cp -r dist/web/* deploy-web/ 2>/dev/null || true
        echo "‚úÖ –§–∞–π–ª—ã –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã"
      
    - name: Deploy Web App to Beget FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./deploy-web/
        server-dir: ${{ secrets.FTP_WEB_PATH }}/
        dangerous-clean-slate: false
        dry-run: false
        exclude: |
          **/.git*
          **/.git*/**
          **/.DS_Store
          **/Thumbs.db
          **/*.map
        log-level: verbose
      
    - name: Deployment Success
      run: |
        echo "üéâ –î–µ–ø–ª–æ–π Web App —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
        echo "üåê Web App: https://develonik.ru/"
        echo ""
        echo "‚ö†Ô∏è –í–ê–ñ–ù–û: Telegram Bot –ù–ï –¥–µ–ø–ª–æ–∏—Ç—Å—è –Ω–∞ Beget!"
        echo "   Beget –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç Node.js –∏ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã."
        echo ""
        echo "üìã –ß—Ç–æ –¥–µ–ª–∞—Ç—å —Å –±–æ—Ç–æ–º:"
        echo "   1. –î–µ–ø–ª–æ–π –±–æ—Ç–∞ –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä —Å Node.js:"
        echo "      ‚Ä¢ Railway.app (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è, –±–µ—Å–ø–ª–∞—Ç–Ω–æ)"
        echo "      ‚Ä¢ Render.com (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, –º–æ–∂–µ—Ç –∑–∞—Å—ã–ø–∞—Ç—å)"
        echo "      ‚Ä¢ Fly.io (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)"
        echo "      ‚Ä¢ VPS (DigitalOcean, Vultr –∏ —Ç.–¥.)"
        echo ""
        echo "   2. –°–º. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: BOT_DEPLOYMENT.md"
        echo ""
        echo "üìÖ –í—Ä–µ–º—è: $(date)"

