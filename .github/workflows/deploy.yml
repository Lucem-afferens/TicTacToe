name: Deploy to Beget

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '7.4'
      
      - name: Create deployment directory
        run: |
          mkdir -p deploy
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ„Ð°Ð¹Ð»Ñ‹ Ð¸Ð· dist
          cp -r dist/* deploy/ 2>/dev/null || true
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ (ÐµÑÐ»Ð¸ Ð¸Ñ… Ð½ÐµÑ‚)
          mkdir -p deploy/data deploy/logs deploy/cache
          # ÐÐ• ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ JSON Ñ„Ð°Ð¹Ð»Ñ‹ - Ð¾Ð½Ð¸ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑ‚ÑŒÑÑ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
          # ÐŸÑ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ð¸ Ð¾Ð½Ð¸ ÑÐ¾Ð·Ð´Ð°Ð´ÑƒÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸
      
      - name: Create config.local.php from GitHub Secret
        run: |
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³ Ñ Ñ‚Ð¾ÐºÐµÐ½Ð¾Ð¼ Ð¸Ð· GitHub Secrets
          # Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» ÐÐ• Ð¿Ð¾Ð¿Ð°Ð´Ð°ÐµÑ‚ Ð² git Ð¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
          cat > deploy/config.local.php << 'EOF'
          <?php
          /**
           * Ð›Ð¾ÐºÐ°Ð»ÑŒÐ½Ð°Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ (ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ Ð´ÐµÐ¿Ð»Ð¾Ðµ)
           * Ð­Ñ‚Ð¾Ñ‚ Ñ„Ð°Ð¹Ð» ÐÐ• Ð¿Ð¾Ð¿Ð°Ð´Ð°ÐµÑ‚ Ð² git Ð¸ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ ÑÐµÐºÑ€ÐµÑ‚Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
           * Ð¡Ð¾Ð·Ð´Ð°ÐµÑ‚ÑÑ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¸Ð· GitHub Secrets
           */
          if (!defined('LOCAL_BOT_TOKEN')) {
              define('LOCAL_BOT_TOKEN', '${{ secrets.BOT_TOKEN }}');
          }
          EOF
          echo "âœ… config.local.php created (token from GitHub Secrets)"
      
      - name: Deploy to Beget via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./deploy/
          server-dir: ${{ secrets.FTP_PATH }}/
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.env
            **/.env.*
            **/composer.json
            **/composer.lock
            **/package.json
            **/package-lock.json
            **/.DS_Store
            **/README.md
            **/DEPLOYMENT.md
            **/PLAN.md
            **/Ð·Ð°Ð¿Ñ€Ð¾Ñ.md
            **/.cursor/**
            **/.gitignore
            **/.htaccess.bak
            **/*.md
            # ÐÐ• Ð¸ÑÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ config.local.php - Ð¾Ð½ Ð½ÑƒÐ¶ÐµÐ½ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
            # ÐÐ• Ð¸ÑÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ - Ð¾Ð½Ð¸ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ ÑÐ¾Ñ…Ñ€Ð°Ð½ÑÑ‚ÑŒÑÑ Ð½Ð° ÑÐµÑ€Ð²ÐµÑ€Ðµ
          dangerous-clean-slate: false
          dry-run: false
      
      - name: Setup webhook after deployment
        run: |
          echo "âœ… Deployment completed!"
          echo "ðŸ“ Next: Run https://develonik.ru/setup/setup-webhook.php to configure webhook"
      
      - name: Deployment summary
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ðŸ“ Files deployed to: ${{ secrets.FTP_PATH }}"
          echo "ðŸŒ Domain: develonik.ru"
          echo "ðŸ¤– Bot: @TicTacToe_ru_bot"
          echo ""
          echo "âš ï¸  Next steps:"
          echo "1. âœ… BOT_TOKEN automatically set from GitHub Secrets (config.local.php created)"
          echo "2. Run https://develonik.ru/setup/setup-webhook.php to configure Telegram webhook"
          echo "3. Test the bot: https://t.me/TicTacToe_ru_bot"
