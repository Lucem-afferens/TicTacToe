name: Deploy TicTacToe Bot & Web App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # ============================================
  # Job 1: Build and Test
  # ============================================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linter
      run: npm run lint || echo "Linter not configured yet"
      continue-on-error: true
      
    - name: Run tests
      run: npm test || echo "Tests not configured yet"
      continue-on-error: true
      
    - name: Build project
      run: npm run build
      
    - name: Verify build output
      run: |
        echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–±–æ—Ä–∫–∏..."
        if [ -d "dist/bot" ]; then
          echo "‚úÖ Bot build —É—Å–ø–µ—à–µ–Ω"
          ls -la dist/bot/ | head -5
        fi
        if [ -d "dist/web" ]; then
          echo "‚úÖ Web App build —É—Å–ø–µ—à–µ–Ω"
          ls -la dist/web/ | head -5
        fi

  # ============================================
  # Job 2: Deploy Web App to Beget
  # –í–ê–ñ–ù–û: Bot –ù–ï –¥–µ–ø–ª–æ–∏—Ç—Å—è –Ω–∞ Beget, —Ç–∞–∫ –∫–∞–∫ —Ç–∞–º –Ω–µ—Ç Node.js
  # Bot –Ω—É–∂–Ω–æ –¥–µ–ø–ª–æ–∏—Ç—å –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (Railway, Render, VPS)
  # –°–º. BOT_DEPLOYMENT.md –¥–ª—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π
  # ============================================
  deploy-web:
    name: Deploy Web App to Beget
    needs: build-and-test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build project
      run: npm run build
      
    - name: Verify build output
      run: |
        echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–±–æ—Ä–∫–∏..."
        if [ -d "dist/web" ]; then
          echo "‚úÖ Web App build —É—Å–ø–µ—à–µ–Ω"
          ls -la dist/web/ | head -5
        fi
        if [ -d "dist/bot" ]; then
          echo "‚úÖ Bot build —É—Å–ø–µ—à–µ–Ω"
          ls -la dist/bot/ | head -5
        fi
      
    - name: Prepare Web App files
      run: |
        echo "üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ Web App —Ñ–∞–π–ª–æ–≤..."
        mkdir -p deploy-web
        cp -r dist/web/* deploy-web/ 2>/dev/null || true
        # –ö–æ–ø–∏—Ä—É–µ–º PHP —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        cp web/setup-webhook.php deploy-web/setup-webhook.php 2>/dev/null || true
        echo "‚úÖ –§–∞–π–ª—ã –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã"
      
    - name: Deploy Web App to Beget FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./deploy-web/
        server-dir: ${{ secrets.FTP_WEB_PATH }}/
        dangerous-clean-slate: false
        dry-run: false
        exclude: |
          **/.git*
          **/.git*/**
          **/.DS_Store
          **/Thumbs.db
          **/*.map
        log-level: verbose
      
    - name: Set bot deployment path
      id: bot-path
      run: |
        if [ -n "${{ secrets.FTP_BOT_PATH }}" ]; then
          echo "path=${{ secrets.FTP_BOT_PATH }}" >> $GITHUB_OUTPUT
        else
          echo "path=${{ secrets.FTP_WEB_PATH }}/bot" >> $GITHUB_OUTPUT
        fi
      
    - name: Prepare bot deployment directory
      run: |
        echo "üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –¥–µ–ø–ª–æ—è –±–æ—Ç–∞..."
        mkdir -p deploy-bot/bot deploy-bot/shared
        cp -r dist/bot/* deploy-bot/bot/ 2>/dev/null || true
        cp -r dist/shared/* deploy-bot/shared/ 2>/dev/null || true
        cp dist/bot/.env deploy-bot/bot/.env 2>/dev/null || true
        
        # –ö–æ–ø–∏—Ä—É–µ–º —Å–∫—Ä–∏–ø—Ç—ã –∑–∞–ø—É—Å–∫–∞
        cp bot/start.sh deploy-bot/bot/start.sh 2>/dev/null || true
        cp bot/install-and-start.sh deploy-bot/bot/install-and-start.sh 2>/dev/null || true
        chmod +x deploy-bot/bot/*.sh 2>/dev/null || true
        
        echo "‚úÖ –§–∞–π–ª—ã –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã"
        echo "üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ deploy-bot/:"
        ls -la deploy-bot/ | head -10
        echo "üìÅ Bot —Ñ–∞–π–ª—ã:"
        ls -la deploy-bot/bot/ | head -10
        echo "üìÅ Shared —Ñ–∞–π–ª—ã:"
        ls -la deploy-bot/shared/ | head -5
      
    - name: Deploy Bot, Shared modules and .env to Beget FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./deploy-bot/
        server-dir: ${{ steps.bot-path.outputs.path }}/
        dangerous-clean-slate: false
        dry-run: false
        exclude: |
          **/.git*
          **/.git*/**
          **/.DS_Store
          **/Thumbs.db
        log-level: verbose
      
    - name: Prepare package files for bot
      run: |
        echo "üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ package.json –¥–ª—è –±–æ—Ç–∞..."
        mkdir -p deploy-bot
        cp package.json deploy-bot/package.json
        cp package-lock.json deploy-bot/package-lock.json 2>/dev/null || true
        echo "‚úÖ –§–∞–π–ª—ã –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã"
      
    - name: Deploy package files for bot
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./deploy-bot/
        server-dir: ${{ steps.bot-path.outputs.path }}/
        dangerous-clean-slate: false
        dry-run: false
        exclude: |
          **/.git*
          **/.git*/**
          **/.DS_Store
          **/Thumbs.db
          bot/**
          shared/**
        log-level: verbose
      
    - name: Deployment Success
      run: |
        echo "üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
        echo "üåê Web App: https://develonik.ru/"
        echo "ü§ñ Bot: –∑–∞–¥–µ–ø–ª–æ–µ–Ω –≤ ${{ steps.bot-path.outputs.path }}/"
        echo "üîê .env —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–µ –≤ Git)"
        echo ""
        echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:"
        echo "   1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É —á–µ—Ä–µ–∑ SSH"
        echo "   2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –±–æ—Ç–∞: cd ${{ steps.bot-path.outputs.path }}"
        echo "   3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–∫—Ä–∏–ø—Ç: bash install-and-start.sh"
        echo ""
        echo "   –ò–ª–∏ –≤—Ä—É—á–Ω—É—é:"
        echo "   cd ${{ steps.bot-path.outputs.path }}"
        echo "   npm install --production"
        echo "   npm run build:bot"
        echo "   npm run start:webhook"
        echo ""
        echo "üìÖ –í—Ä–µ–º—è: $(date)"

