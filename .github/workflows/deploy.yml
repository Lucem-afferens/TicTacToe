name: Deploy TicTacToe Bot & Web App

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # ============================================
  # Job 1: Build and Test
  # ============================================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Run linter
      run: npm run lint || echo "Linter not configured yet"
      continue-on-error: true
      
    - name: Run tests
      run: npm test || echo "Tests not configured yet"
      continue-on-error: true
      
    - name: Build project
      run: npm run build
      
    - name: Verify build output
      run: |
        echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–±–æ—Ä–∫–∏..."
        if [ -d "dist/bot" ]; then
          echo "‚úÖ Bot build —É—Å–ø–µ—à–µ–Ω"
          ls -la dist/bot/ | head -5
        fi
        if [ -d "dist/web" ]; then
          echo "‚úÖ Web App build —É—Å–ø–µ—à–µ–Ω"
          ls -la dist/web/ | head -5
        fi

  # ============================================
  # Job 2: Deploy Web App and Bot to Beget
  # ============================================
  deploy:
    name: Deploy to Beget
    needs: build-and-test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build project
      run: npm run build
      
    - name: Verify build output
      run: |
        echo "üì¶ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å–±–æ—Ä–∫–∏..."
        if [ -d "dist/web" ]; then
          echo "‚úÖ Web App build —É—Å–ø–µ—à–µ–Ω"
          ls -la dist/web/ | head -5
        fi
        if [ -d "dist/bot" ]; then
          echo "‚úÖ Bot build —É—Å–ø–µ—à–µ–Ω"
          ls -la dist/bot/ | head -5
        fi
      
    - name: Create .env file for bot
      run: |
        echo "üîê –°–æ–∑–¥–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –¥–ª—è –±–æ—Ç–∞..."
        mkdir -p dist/bot
        cat > dist/bot/.env << EOF
        BOT_TOKEN=${{ secrets.BOT_TOKEN }}
        BOT_USERNAME=${{ secrets.BOT_USERNAME || 'TicTacToe_ru_bot' }}
        WEB_APP_URL=${{ secrets.WEB_APP_URL || 'https://develonik.ru/' }}
        NODE_ENV=production
        EOF
        echo "‚úÖ .env —Ñ–∞–π–ª —Å–æ–∑–¥–∞–Ω (–±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—Å—è –≤ Git)"
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ç–æ–∫–µ–Ω –µ—Å—Ç—å (–Ω–æ –Ω–µ –≤—ã–≤–æ–¥–∏–º –µ–≥–æ)
        if [ -z "${{ secrets.BOT_TOKEN }}" ]; then
          echo "‚ö†Ô∏è BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ GitHub Secrets"
        else
          echo "‚úÖ BOT_TOKEN —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        fi
      
    - name: Deploy Web App to Beget FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./dist/web/
        server-dir: ${{ secrets.FTP_WEB_PATH }}/
        dangerous-clean-slate: false
        dry-run: false
        exclude: |
          **/.git*
          **/.git*/**
          **/.DS_Store
          **/Thumbs.db
          **/*.map
        log-level: verbose
      
    - name: Set bot deployment path
      id: bot-path
      run: |
        if [ -n "${{ secrets.FTP_BOT_PATH }}" ]; then
          echo "path=${{ secrets.FTP_BOT_PATH }}" >> $GITHUB_OUTPUT
        else
          echo "path=${{ secrets.FTP_WEB_PATH }}/bot" >> $GITHUB_OUTPUT
        fi
      
    - name: Deploy Bot, Shared modules and .env to Beget FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./dist/
        server-dir: ${{ steps.bot-path.outputs.path }}/
        dangerous-clean-slate: false
        dry-run: false
        include: |
          bot/**
          shared/**
        exclude: |
          **/.git*
          **/.git*/**
          **/.DS_Store
          **/Thumbs.db
          web/**
        log-level: verbose
      
    - name: Deploy package files for bot
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ${{ secrets.FTP_HOST }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./
        server-dir: ${{ steps.bot-path.outputs.path }}/
        dangerous-clean-slate: false
        dry-run: false
        include: |
          package.json
          package-lock.json
        exclude: |
          **/*
          !package.json
          !package-lock.json
        log-level: verbose
      
    - name: Deployment Success
      run: |
        echo "üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
        echo "üåê Web App: https://develonik.ru/"
        echo "ü§ñ Bot: –∑–∞–¥–µ–ø–ª–æ–µ–Ω –≤ ${{ steps.bot-path.outputs.path }}/"
        echo "üîê .env —Ñ–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–µ –≤ Git)"
        echo "üìÖ –í—Ä–µ–º—è: $(date)"

